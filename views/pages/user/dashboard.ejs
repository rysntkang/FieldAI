<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>FieldAi Dashboard</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    .custom-bg {
      background-color: #f8f9fa;
    }

    .sidebar {
      height: 100vh;
      position: sticky;
      top: 0;
    }

    .content {
      padding: 20px;
    }

    .static-bottom {
      position: sticky;
      bottom: 0;
    }

    #temperatureChart {
      max-height: 400px;
    }

    .chart-container {
      position: relative;
      height: 400px;
    }
  </style>
</head>
<body>
  <%- include('../../partials/user/header') %>

  <div class="container-fluid">
    <div class="row">
      <%- include('../../partials/user/sidebar') %>

      <main class="content col-md-9 col-lg-10">
        <div class="row">
          <div class="col-md-12">
            <h4>Temperature Trends</h4>
            <canvas id="temperatureChart"></canvas>
          </div>
        </div>
        <div class="row">
          <div class="col-md-12">
            <h4>Rainfall and Irrigation Tracker</h4>
            <canvas id="rainfallChart"></canvas>
          </div>
        </div>
        
      </main>
    </div>
  </div>

  <!-- Footer -->
  <footer class="bg-dark text-center text-white py-3 static-bottom">
    <%- include('../../partials/user/footer') %>
  </footer>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      try {
        const temperatureData = <%- JSON.stringify(temperatureData) %>;
  
        const labels = temperatureData.map((data) => data.date);
        const tempMax = temperatureData.map((data) => data.temp_max);
        const tempMin = temperatureData.map((data) => data.temp_min);
  
        const ctx = document.getElementById('temperatureChart').getContext('2d');
        new Chart(ctx, {
          type: 'line',
          data: {
            labels: labels,
            datasets: [
              {
                label: 'Max Temperature (°C)',
                data: tempMax,
                borderColor: 'rgba(255, 99, 132, 1)',
                backgroundColor: 'rgba(255, 99, 132, 0.2)',
                fill: true,
              },
              {
                label: 'Min Temperature (°C)',
                data: tempMin,
                borderColor: 'rgba(54, 162, 235, 1)',
                backgroundColor: 'rgba(54, 162, 235, 0.2)',
                fill: true,
              },
            ],
          },
          options: {
            responsive: true,
            plugins: {
              legend: {
                position: 'top',
              },
              title: {
                display: true,
                text: 'Daily Temperature Trends',
              },
            },
          },
        });
      } catch (error) {
        console.error('Error rendering the temperature chart:', error);
        alert('Failed to load temperature data. Please try again later.');
      }
    });

    document.addEventListener('DOMContentLoaded', async () => {
    try {
      const response = await fetch('/user/rainfall-irrigation');
      if (!response.ok) throw new Error('Failed to fetch rainfall data.');

      const rainfallData = await response.json();

      const labels = rainfallData.map((data) => data.date);
      const precipitation = rainfallData.map((data) => data.precipitation);
      const irrigationNeeded = rainfallData.map((data) => data.irrigationNeeded ? 5 : null); // Use 5mm as a threshold marker

      const ctx = document.getElementById('rainfallChart').getContext('2d');
      new Chart(ctx, {
        type: 'bar',
        data: {
          labels: labels,
          datasets: [
            {
              label: 'Rainfall (mm)',
              data: precipitation,
              backgroundColor: 'rgba(54, 162, 235, 0.6)',
              borderColor: 'rgba(54, 162, 235, 1)',
              borderWidth: 1,
            },
            {
              label: 'Irrigation Needed',
              data: irrigationNeeded,
              type: 'line',
              borderColor: 'rgba(255, 99, 132, 1)',
              backgroundColor: 'rgba(255, 99, 132, 0.2)',
              fill: true,
            },
          ],
        },
        options: {
          responsive: true,
          plugins: {
            legend: {
              position: 'top',
            },
            title: {
              display: true,
              text: 'Rainfall and Irrigation Tracker',
            },
          },
          scales: {
            y: {
              beginAtZero: true,
              title: {
                display: true,
                text: 'Rainfall (mm)',
              },
            },
          },
        },
      });
    } catch (error) {
      console.error('Error displaying the rainfall chart:', error);
      alert('Failed to load rainfall data. Please try again later.');
    }
  });

  </script>
</body>
</html>
